@page "/"

@using Backi.Timers
@using CommunityToolkit.Maui.Alerts
@using CoreBluetooth
@using CoreFoundation
@using Microsoft.Extensions.Logging
@using Nativno.Bluetooth.Mac.Playground.Helpers

<h3>BLE scan (bare)</h3>
<h3>State: @_stateString</h3>

<button @onclick="ScanFresh">Fresh Scan</button>
<button @onclick="Stop">Stop</button>

<span>Found: @trackedPeripheral.Items.Count</span>

<ul>
    @foreach (var (k, e) in trackedPeripheral.Items)
    {
        @* <PeripheralInfoView PeripheralId="@k">
            <button @onclick="() => Connect(k)">Connect</button>
        </PeripheralInfoView> *@
        
        <li>
            @e.Discovery.Peripheral.RSSI?.Int32Value
            · @e.Discovery.Peripheral.Identifier.AsString()
            · @e.Discovery.Peripheral.Name
            · @e.ConnectionState
            @if (e.ConnectionState == PeripheralConnectionState.Disconnected)
            {
                <span> · </span>
                <button @onclick="() => Connect(e.Discovery.Peripheral.Identifier.ToString())">Connect</button>
            }
            @if (e.ConnectionState == PeripheralConnectionState.Connected)
            {
                <span> · </span>
                <button @onclick="() => Disconnect(e.Discovery.Peripheral.Identifier.ToString())">Disconnect</button>
            }
        </li>
    }
</ul>

@inject ILogger<Home> logger
@* @inject PeripheralsCollection peripherals *@
@inject TrackedPeripheralCollection trackedPeripheral
@inject CBCentralManager _central

@code
{
    string _stateString = "";
    readonly Dictionary<string, CBDiscoveredPeripheralEventArgs> _items = new();
    // readonly CBCentralManager _central = new(dispatchQueue: DispatchQueue.MainQueue);

    protected override void OnInitialized()
    {
        @* _central.DiscoveredPeripheral += (_, e) =>
        {
            peripherals.PutIfPeripheralIsNamed(e);
            trackedPeripheral.RegisterDiscoveryOnNamedPeripheral(e);
            InvokeAsync(StateHasChanged);
        }; *@

        trackedPeripheral.SubscribeToPeripheralsDiscoveries(_central);
        trackedPeripheral.SubscribeToConnectionStatuses(_central);

        trackedPeripheral.ListUpdatedNotifier.Subscribe(() => InvokeAsync(StateHasChanged));
        
        trackedPeripheral.ConnectionStatusUpdatedNotifier.Subscribe((_) => InvokeAsync(StateHasChanged));
        trackedPeripheral.ConnectionStatusUpdatedNotifier.Subscribe((c) => Toast.Make($"{c.Discovery.Peripheral.Name} {c.ConnectionState}").Show());
        trackedPeripheral.ConnectionStatusUpdatedNotifier.Subscribe(c => logger.LogInformation("Connection status updated {Peripheral} {State}", c.Discovery.Peripheral.Name, c.ConnectionState));

        @* _central.ConnectedPeripheral += (_, e) => logger.LogInformation("connected, {event}", e);
        _central.FailedToConnectPeripheral += (_, e) => logger.LogInformation("failed to connect");
        _central.DidDisconnectPeripheral  += (_, e) => logger.LogInformation("did disconnect peripheral");
        _central.DisconnectedPeripheral += (_, e) => logger.LogInformation("disconnected peripheral");

        _central.ConnectedPeripheral += (_, e) => InvokeAsync(StateHasChanged);
        _central.FailedToConnectPeripheral += (_, e) => InvokeAsync(StateHasChanged);
        _central.DidDisconnectPeripheral  += (_, e) => InvokeAsync(StateHasChanged);
        _central.DisconnectedPeripheral += (_, e) => InvokeAsync(StateHasChanged);
        
        peripherals.SubscribeOnConnectionEvent(_central); *@

        @* _central.ConnectedPeripheral += (_, e) => peripherals.Connected = e.Peripheral;
        _central.ConnectedPeripheral += async (_, e) => await Toast.Make("Connected").Show(); *@

        SafeTimer.RunNowAndPeriodically(
            TimeSpan.FromSeconds(2),
            () =>
            {
                trackedPeripheral.RemoveOldDiscoveries(TimeSpan.FromSeconds(5));
                _stateString = $"{_central.State}";
                InvokeAsync(StateHasChanged);
            },
            ex => logger.LogError(ex, "Error while refreshing state view")
        );

        ScanFresh();
    } 
    
    void ScanFresh()
    {
        trackedPeripheral.Items.Clear();
        
        if (_central.State == CBManagerState.PoweredOn)
        {
            _central.ScanForPeripherals(peripheralUuids: null);    
        }
    }

    void Connect(string peripheralId)
    {
        var peripheral = trackedPeripheral.Items[peripheralId].Discovery.Peripheral;
        
        logger.LogInformation("initiating connection to {peripheral}", peripheral);
        
        _central.ConnectPeripheral(peripheral);
        trackedPeripheral.UpdateConnectionStatus(peripheral, PeripheralConnectionState.Connecting);
    }

    void Disconnect(string peripheralId)
    {
        var peripheral = trackedPeripheral.Items[peripheralId].Discovery.Peripheral;
        
        logger.LogInformation("initiating connection to {peripheral}", peripheral);
        
        _central.CancelPeripheralConnection(peripheral);
    }

    void Stop()
    {
        _central.StopScan();
    }
}

